<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BIM总发包管理平台</title>
</head>

<body style="margin: 0;padding: 0;overflow: hidden;" onunload="unLoadEvent()">
    <!-- <object ID="WebView" style="width: 100%;" CLASSID="CLSID:15A5F85D-A81B-45D1-A03A-6DBC69C891D1">
		<PARAM NAME="url" VALUE="" />
			</object> -->
	<script src="http://lib.sinaapp.com/js/jquery/1.9.1/jquery-1.9.1.min.js"></script>

    <script type="text/javascript"> 
    	 
	    var myWebView = document.createElement("object");

	    myWebView.classid = "CLSID:15A5F85D-A81B-45D1-A03A-6DBC69C891D1";

	    var viewport = document.body,cookUrl=getCookie("path");
	    viewport.appendChild(myWebView);  
	     
	    var url= cookUrl && cookUrl.lastIndexOf("/file/data")<=-1 && cookUrl || window.location.href.substring(window.location.href.lastIndexOf("path") + 5) || window.location.host+"/login.html";

	    myWebView.url = url;
	    myWebView.id="webView";
	    myWebView.registerEvent('newWindow', navigateTo); 

	    myWebView.registerEvent('urlChanged', function(url){
	    	//登录后设置 cookie
	    	myWebView.runScript("document.cookie",function(cookies){
	    		 //比较cookie
	    		if (getCookie("userId") != getCookie("userId",cookies)) {
	    			//登录设置 登出删除
	    	 		var keys = cookies.match(/[^ =;]+(?=\=)/g);
	    	 		if (keys && keys.length>1) {
	    	 			for(var i=0;i<keys.length;i++){
	    	 				setCookie(keys[i],getCookie(keys[i],cookies));
	    	 			}
	    	 		}else{
	    	 			var keys = document.cookie.match(/[^ =;]+(?=\=)/g);
	    	 			for(var i=0;i<keys.length;i++){
	    	 				delCookie(keys[i]);
	    	 			}
	    	 		}
	    	    } 
	    	 	
	    	});

	    	
	    	 //myWebView
	    });

	    //文件下载
	      myWebView.registerEvent('download', function(url){  
	      		window.location.href=url;
	      }); 	


	    myWebView.height = document.body.parentElement.clientHeight + "px";

	    resizeWebView();

	    window.onresize=resizeWebView;

	    delCookie("path");

	    function navigateTo(url) {
	        var aLink = "<a href='" + url + "' target='_blank' >test</a>";
	        var a = $(aLink).get(0);
	        var e = document.createEvent('MouseEvents');
	        e.initEvent('click', true, true);
	        a.dispatchEvent(e);
	    }

	    function resizeWebView() {
	       //重置
	    	myWebView.width = 0;
	        myWebView.height =0;
	    	var $body=$(document);
	    	myWebView.width =  $body.width();
	        myWebView.height = $body.height();
	    } 
	 

	    //刷新
	    function unLoadEvent(){ 
	    	var url=myWebView.url;
	    	//不是单页面
	    	if (url.lastIndexOf("/static/dist/app/")<=-1) {
	    		setCookie("path",url); 
	    	}
	    	
	    }

	   function setCookie(name, value) {
			var Days = 0.01,
				exp = new Date();
			exp.setTime(exp.getTime() + Days * 24 * 60 * 60 * 1000);
			document.cookie = name + "=" + escape(value) + ";expires=" + exp.toGMTString() + ";path=/";
		}
		//获取cookie
		function getCookie(name,cookis) {
			var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");

			if (!cookis) {
				cookis=document.cookie;
			}

			if (arr = cookis.match(reg))
				return unescape(arr[2]);
			else
				return null;
		}
		//删除cookie
		function delCookie(name) {
			var exp = new Date();
			exp.setTime(exp.getTime() - 31 * 24 * 60 * 60 * 1000);
			var cval = this.getCookie(name);
			if (cval != null)
				document.cookie = name + "=" + cval + ";expires=" + exp.toGMTString() + ";path=/";
		}

    </script>
</body>

</html>
