<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BIM总发包管理平台</title>
    <meta http-equiv="pragma" content="no-cache">
    <style type="text/css">
    #newVersion {
        position: fixed;
        top: 0px;
        left: 0px;
        font-size: 50px;
        color: red;
        z-index: 9999;
        background-color: #000;
    }
    </style>
</head>

<body style="margin: 0;padding: 0;overflow: hidden;" onunload="unLoadEvent()">
    <!-- <object ID="WebView" style="width: 100%;" CLASSID="CLSID:15A5F85D-A81B-45D1-A03A-6DBC69C891D1">
        <PARAM NAME="url" VALUE="" />
            </object> -->
    <script src="libs/jquery/jquery-1.12.0.min.js"></script>
    <script type="text/javascript">
    var hasDevicePixelRatio = true;
    try {

        var myWebView = document.createElement("object"),
            currentVersion = 3;

        myWebView.classid = "CLSID:15A5F85D-A81B-45D1-A03A-6DBC69C891D1";

        var viewport = document.body,
            cookUrl = getCookie("path");
        viewport.appendChild(myWebView);

        if (myWebView.pluginVersion != currentVersion) {
            throw new error("version is old");
        }
        var url = cookUrl && cookUrl.lastIndexOf("/file/data") <= -1 && (new Date() - getCookie("pathDate")) / 1000 <= 2 &&
            cookUrl.lastIndexOf("about:blank") <= -1 && cookUrl ||
            window.location.href.substring(window.location.href.lastIndexOf("path") + 5) ||
            window.location.host + "/#projects";

        myWebView.url = url;
        myWebView.id = "webView";
        myWebView.registerEvent('newWindow', navigateTo);

        myWebView.registerEvent('urlChanged', function(url) {

            if (myWebView.url == "about:blank") {
                window.opener = null;
                window.open("", "_self");
                window.close();
            }


            //登录后设置 cookie
            myWebView.runScript("App.Comm.getCookAndStore()", function(cookStore) {

                if (!cookStore) {
                    return;
                }

                cookStore = JSON.parse(cookStore);

                var cookies = cookStore.cookie,
                    user = cookStore.user;
                //比较cookie
                if (getCookie("OUTSSO_AuthMAC") != getCookie("OUTSSO_AuthMAC", cookies)) {
                    //登录设置 登出删除
                    var keys = cookies.match(/[^ =;]+(?=\=)/g),
                    lastKey = "AuthUser_AuthToken",
                            lastValue=cookStore.data;  
                            
                    if (keys && keys.length > 5) { 
                        var key, value; 
                        for (var i = 0; i < keys.length; i++) { 
                            key = keys[i];
                            value = getCookie(keys[i], cookies);
                            if (key!=lastKey) {
                                 setCookie(key, value);
                            }  
                        } 

                        lastValue &&　setCookie(lastKey, lastValue);　

                        localStorage.user = user;

                    } else {
                        var keys = document.cookie.match(/[^ =;]+(?=\=)/g);
                        for (var i = 0; i < keys.length; i++) {
                            delCookie(keys[i]);
                        }
                        localStorage.removeItem("user");
                    }
                }

            });
        });

        //文件下载
        myWebView.registerEvent('download', function(url) {
            window.location.href = url;
        });

        if (url.indexOf("login.html") > -1) {

            var timer = setTimeout(function() {

                clearTimeout(timer);

                myWebView.runScript('Login.checkLoginBefore("' + document.cookie + '")', function(isLogin) {});
                myWebView.runScript('Login.checkLogin()', function(isLogin) {});

            });


        }

        myWebView.height = document.body.parentElement.clientHeight + "px";


        window.onresize = resizeWebView;

        delCookie("path");

        resizeWebView();

    } catch (e) {

        if (myWebView.pluginVersion != currentVersion) {
            var html = templateUrl("/app/oPage/downloadIE.html");
            $("body").html(html);
        } else if (!isIE()) {
            var html = templateUrl("/app/oPage/tipIE.html");
            $("body").html(html);
        } else {
            var html = templateUrl("/app/oPage/downloadIE.html");
            $("body").html(html);
        }
    }


    function templateUrl(url) {

        var result;
        $.ajax({
            url: "/static/dist" + url,
            type: 'GET',
            async: false
        }).done(function(tpl) {
            result = tpl;
        });

        return result;

    }


    function isIE() {
        if ("ActiveXObject" in window || window.ActiveXObject) {
            return true;
        } else {
            return false;
        }
    }

    function navigateTo(url) {
        var aLink = "<a href='" + url + "' target='_blank' >test</a>";
        var a = $(aLink)[0];
        var e = document.createEvent('MouseEvents');
        e.initEvent('click', true, true);
        a.dispatchEvent(e);
    }

    function resizeWebView() {

        //重置
        myWebView.width = "0";
        myWebView.height = "0";
        var $body = $(document);
        myWebView.width = $body.width() + "";
        myWebView.height = $body.height() + "";

        if (!window.devicePixelRatio) {
            myWebView.zoomFactor = screen.deviceXDPI / screen.logicalXDPI;
        } else {
            myWebView.zoomFactor = window.devicePixelRatio;
        }
    }


    //刷新
    function unLoadEvent() {
        var url = myWebView.url;
        if (!url) {
            return;
        }
        //不是单页面
        if (url.lastIndexOf("/static/dist/app/") <= -1) {
            setCookie("path", url);
            setCookie("pathDate", +new Date());
        }

    }

    function setCookie(name, value) {
        var Days = 1,
            exp = new Date();
        exp.setTime(exp.getTime() + Days * 24 * 60 * 60 * 1000);
        document.cookie = name + "=" + escape(value) + ";domain=" + window.location.host.substring(window.location.host.indexOf(".")) + ";expires=" + exp.toGMTString() + ";path=/";
    }
    //获取cookie
    function getCookie(name, cookis) {

        try {

            var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");

            if (!cookis) {
                cookis = document.cookie;
            }
            if (arr = cookis.match(reg))
                return unescape(arr[2]);
            else
                return null;
        } catch (e) {
            return '';
        }

    }
    //删除cookie
    function delCookie(name) {
        var exp = new Date();
        exp.setTime(exp.getTime() - 31 * 24 * 60 * 60 * 1000);
        var cval = this.getCookie(name);
        if (cval != null)
            document.cookie = name + "=" + cval + ";domain=" + window.location.host.substring(window.location.host.indexOf(".")) + ";expires=" + exp.toGMTString() + ";path=/";
    }
    </script>
</body>

</html>
