<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!--<meta http-equiv="pragma" content="no-cache"> -->
    <META HTTP-EQUIV="pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Cache-Control" CONTENT="no-store, must-revalidate">
    <title>BIM总发包管理平台- 隐患填报模拟</title>
    <link rel="styleSheet" href="/static/dist/qualityFill/css/quality.css" />
    <script src="http://cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
    <script src="/static/dist/components/inspectSelection/js/inspectSelection.js"></script>
    <script src="/static/dist/qualityFill/js/template.min.js"></script>
    <script src="/static/dist/qualityFill/js/wDialog.min.js"></script>
</head>
<body>

<div class="container">
    <div style="height:30px;line-height:30px;font-weight:bold;font-size:14px;">项目名称：<span id="projectName"></span></div>
    <div id="grid" class="grid">
        <table border="0" cellpadding="0" cellspacing="0">
            <thead>
                <tr>
                    <td class="chk"><input type="checkbox" name="chk" class="chkAll"/></td>
                    <td class="w150">类别</td>
                    <td class="w190">分部</td>
                    <td class="w190">分项</td>
                    <td>预设点</td>
                    <td class="w150">检查结果</td>
                    <td class="w190">隐患</td>
                    <td>构建位置</td>
                </tr>
            </thead>
            <tbody id="gridContainer">
                <tr>
                    <td class="chk"><input type="checkbox" name="chk" class="checkbox"/></td>
                    <td class="w150">
                        <select class="select-type">
                            <option>工程桩</option>
                            <option>基坑支护</option>
                            <option>地下防水</option>
                            <option>梁柱节点</option>
                            <option>钢结构悬挑构件</option>
                            <option>幕墙</option>
                            <option>外保温</option>
                            <option>采光顶</option>
                            <option>步行街吊顶风口</option>
                            <option>卫生间防水</option>
                            <option>屋面防水</option>
                            <option>屋面虹吸雨排</option>
                            <option>消防泵房</option>
                            <option>给水泵房</option>
                            <option>湿式报警阀室</option>
                            <option>空调机房</option>
                            <option>冷冻机房</option>
                            <option>变配电室</option>
                            <option>发电机房</option>
                            <option>慧云机房</option>
                            <option>电梯机房</option>
                            <option>电梯底坑</option>
                            <option>吊顶</option>
                            <option>地面</option>
                            <option>中庭栏杆</option>
                            <option>竖井</option>
                        </select>
                    </td>
                    <td class="w190"><input type="text" name="part1" class="w180 input_part1"/></td>
                    <td class="w190"><input type="text" name="part2" class="w180 input_part2"/></td>
                    <td>
                        <span class="ready-pos" data-readypos=""></span>
                        <span class="linkBtn-ready-pos"></span>
                    </td>
                    <td>
                    <select class="select-result w150">
                        <option>合格</option>
                        <option>不合格</option>
                    </select>
                    </td>
                    <td class="w190"><input type="text" name="part2" class="w180 input_part3"/></td>
                    <td>
                        <span class="pos" data-pos=""></span>
                        <span class="linkBtn-pos"></span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="options">
        <button id="btn_add">添加</button>
        <button id="btn_delete">删除</button>
        <button id="btn_save">保存</button>
    </div>
</div>

<div id="Dlg_content" style="display:none;">
    <div class="dlg-content">
        <div id="repeatContainer" class="projectItem" style="display:none;">
            <span data-projectCode="{{projectCode}}" data-projectId="{{projectId}}">{{projectName}}</span>
        </div>
    </div>
    <div class="dlg-button">
        <button id="DlgBtn_close">关闭</button>
        <button id="DlgBtn_ok">确定</button>
    </div>
</div>

</body>
</html>
<script type="text/javascript">
Array.clone = function(oldAr,newAr){

}

var readyPosState = ["绑定预设点","解绑"];
var posState = ["绑定构建位置","解绑"];
var Data = {
    projectData:{},
    formData:{
        "messageId": "ddcc2bc8964b4dfabdf05c1898997324",
        "messageType": "QUALITY-1004",
        "timestamp": "1482722921867",
        "code": true,
        "message": "success",
        "data": []
    },
    itemData : {
        "id": "7a6bdcca-b0b4-41eb-92fd-e59a6f87d723",
        "projectCode": "02aa76f5-59fe-47fb-af75-5fb736319f0d",
        "acceptanceType": 1,
        "name": "屋面二次开洞未补做蓄水试验",
        "discoverDate": 1482721932000,
        "rectifyDate": 1482940800000,
        "rectifyCount": 0,
        "status": 1,
        "levelId": 2,
        "organizationTypeID": 1,
        "dangerImageID": "3e972410-0208-41fd-be0e-1f56308b209b",
        "ratingCategoryID": 2,
        "presetPointID": null,
        "PresetPointCompoentID": null,
        "componentID": null,
        "location": null,
        "axis": null
    }
};

var Url = {
    getParam : function(key){
        var search = location.search;
        search = search.replace("?","");
        var items = search.split("&");
        var item,i;
        for(i=0;i<items.length;i++)
        {
            item = items[i].split("=");
            if(item[0]==key)
            {
                return item[1];
            }
        }
        return "";          
    }   
};

var initComponent = function(projectCode){
    jQuery.support.cors = true;
    window.viewer = new InspectModelSelection({
        type: "process",//open process
        ruleType: '',//构件分类
        height: "500px",
        width:"1200px",
        //projectCode: '36caa07c-4c7d-4c95-84ae-fb56f53f0dc3',  //projectNo
        //projectCode : "edbae83a-8a9f-4dfa-9588-18d7d33f71b6",
        projectCode : projectCode,
        /*
        token:"4aeba9fa8574d9a7f5e6ff2fbc54cd5cf45d7f3949df6bdf1f5c49f4349baa01a76b19a3118007e98a2546f76a1e5c7c6dff6a0b87795a92",
        appKey: "60e8a1d9fc1d44d7b6a4cf85ae2987ed",
        */
        appKey: "60e8a1d9fc1d44d7b6a4cf85ae2987ed",
        token: "4aeba9fa8574d9a768aa3aba59e72c0bbe4990ba9d63f1d97d8139fe57b9b84d855bb56f3b437c42ac9454501cfac6e88764578b07e256dcd793183be0b561627222bea5cb3420fee5242fdabfef8ad39dcc2e271e1f0452322fbd98c9681359d23c02b79118bb99773001ea2ba359553023d7ef8b317995",
        callback: function (res) {
            window.viewerData = res;
        },
        withCheckpoint : true
    });
}

var initDialog = function(){
    overLayer.bgColor='#777';
    overLayer.opacity=40;
    var options={
        id:'Dlg',
        hasBar:true,
        barOptions:
        {
            title:"请选择一个项目"
        },
        position:'fixed',
        type:'center',
        contentId:'Dlg_content',
        className:'dialog',
        width:800,
        height:500,
        isMove:false
    };
    window.Dlg = new wDialog(options);
}

var Event = {
    rowDOM : [],
    initDialogEvent : function(){
        $("#Dlg .wClose").hide();
        window.Dlg.show();
        $("#DlgBtn_close").on("click",function(){
            window.Dlg.hide();
            $("#projectName").html(Data.projectData.projectName);
        });
        $("#DlgBtn_ok").on("click",function(){
            window.Dlg.hide();
            $("#projectName").html(Data.projectData.projectName);
            initComponent(Data.projectData.projectCode);
        });
        var $Dlg_content = $("#Dlg .dlg-content");
        $Dlg_content.on("click","div",function(){
            var $dataDOM;
            $Dlg_content.find("div").removeClass("select");
            if(!$(this).hasClass("select"))
            {
                $(this).addClass("select");
                $dataDOM = $(this).find("span");
                Data.projectData.projectCode = $dataDOM.data("projectcode");
                Data.projectData.projectId = $dataDOM.data("projectid");
                Data.projectData.projectName = $dataDOM.html();
            }
        });
    },
    initDialogData : function(){
        $.ajax({
            url:"/platform/project/list/all/quality",
            type:"get",
            dataType:"json",
            success:function(data){
                var list = data.data;
                if(data.code!=0)
                {
                    list = [];
                }
                template.startSymbol("{{");
                template.endSymbol("}}");
                template.repeat({
                    repeatElement:$("#repeatContainer")[0],
                    data:list,
                    type:"cover"
                });
            }
        });
    },
    deleteRow : function(){
        var i;
        var $gridContainer = $("#gridContainer");
        for(i=0;i<this.rowDOM.length;i++)
        {
            $gridContainer[0].removeChild(this.rowDOM[i]);
        }
        this.rowDOM = [];
    },
    checkRow : function(checkbox){
        var trDOM = checkbox.parentNode.parentNode;
        this.rowDOM.push(trDOM);
    },
    checkAllRow : function(){
        var i;
        var $trs = $("#gridContainer tr");
        for(i=0;i<$trs.length;i++)
        {
            this.checkRow($($trs[i]).find(".checkbox")[0]);
        }
    },
    saveData : function(){
        var $trs = $("#gridContainer tr");
        var $this;
        $trs.each(function(index){
            $this = $(this);
            console.log($this.find("select.select-type")[0].value);
            //Data.formData.
        });
        this.sendData();
    },
    sendData : function(){
        $.ajax({
            url:"/sixD/internal/message",
            type:"post",
            dataType:"json",
            data:{
                id:"111"
            },
            success : function(data){

            }

        });
    },
    bindYuSheDian:function(){
        window.viewer.data();
    },
    bindGoJian : function(curDOM){
        window.viewer.data();
        window.viewer.data();
        console.log(window.viewerData.risk);
        /*var json = JSON.stringify(window.viewerData);*/
        try
        {
            if(curDOM.innerHTML == posState[0])
            {
                $(curDOM).prev().html(window.viewerData.risk.components.locationName);
                console.log(window.viewerData.risk.components);
                curDOM.innerHTML = posState[1];
            }
            else
            {
                $(curDOM).prev().html("");
                curDOM.innerHTML = posState[0];
            }
        }
        catch(e){;}
    },
    bindEvent : function(){
    /*事件入口*/
        var th = this;
        this.lineHTML = '<tr><td class="chk"><input type="checkbox" name="chk" class="checkbox"/></td>'+
                        '<td>{select-type}</td>'+
                        '<td><input type="text" name="part1" class="w180 input_part1"/></td>'+
                        '<td><input type="text" name="part2" class="w180 input_part2"/></td>'+
                        '<td>{ready-pos}</td>'+
                        '<td>{select-result}</td>'+
                        '<td><input type="text" name="part2" class="w180 input_part3"/></td>'+
                        '<td>{pos}</td>'+
                        '</tr>';
        this.selectTypeHTML ='<select class="select-type">'+
                                '<option>工程桩</option>'+
                                '<option>基坑支护</option>'+
                                '<option>地下防水</option>'+
                                '<option>梁柱节点</option>'+
                                '<option>钢结构悬挑构件</option>'+
                                '<option>幕墙</option>'+
                                '<option>外保温</option>'+
                                '<option>采光顶</option>'+
                                '<option>步行街吊顶风口</option>'+
                                '<option>卫生间防水</option>'+
                                '<option>屋面防水</option>'+
                                '<option>屋面虹吸雨排</option>'+
                                '<option>消防泵房</option>'+
                                '<option>给水泵房</option>'+
                                '<option>湿式报警阀室</option>'+
                                '<option>空调机房</option>'+
                                '<option>冷冻机房</option>'+
                                '<option>变配电室</option>'+
                                '<option>发电机房</option>'+
                                '<option>慧云机房</option>'+
                                '<option>电梯机房</option>'+
                                '<option>电梯底坑</option>'+
                                '<option>吊顶</option>'+
                                '<option>地面</option>'+
                                '<option>中庭栏杆</option>'+
                                '<option>竖井</option>'+
                            '</select>';
        this.selectResultHTML = '<select class="select-result w150"><option>合格</option><option>不合格</option></select>';
        this.readyPosHTML = '<span class="ready-pos" data-readypos=""></span><span class="linkBtn-ready-pos">{ready-pos-state}</span>';
        this.posHTML =      '<span class="pos" data-pos=""></span><span class="linkBtn-pos">{pos-state}</span>';

        $(".chkAll").on("click",function(){
            if($(this).prop("checked"))
            {
                $(".checkbox").prop("checked",true);
                th.checkAllRow();
            }
            else
            {
                $(".checkbox").prop("checked",false);
            }
        });

        $("#btn_add").on("click",function(){
            th.lineHTML = th.lineHTML.replace("{select-type}",th.selectTypeHTML);
            th.lineHTML = th.lineHTML.replace("{select-result}",th.selectResultHTML);
            th.lineHTML = th.lineHTML.replace("{ready-pos}",th.readyPosHTML);
            th.lineHTML = th.lineHTML.replace("{pos}",th.posHTML);
            th.lineHTML = th.lineHTML.replace("{ready-pos-state}",readyPosState[0]);
            th.lineHTML = th.lineHTML.replace("{pos-state}",posState[0]);
            $("#gridContainer").append(th.lineHTML);
        });
        $("#gridContainer").on("click",".checkbox",function(){
            th.checkRow(this);
        });
        $("#btn_delete").on("click",function(){
            th.deleteRow();
        });
        $("#btn_save").on("click",function(e){
            th.saveData();
        });
        /*绑定预设点*/
        $("#gridContainer").on("click",".linkBtn-ready-pos",function(){
            th.checkRow(this);
        });
        /*绑定构建位置*/
        $("#gridContainer").on("click",".linkBtn-pos",function(){
            th.bindGoJian(this);
        });       
        //this.initDialogEvent();
        //this.initDialogData();
    }
};


var initOptions = function(){
    var $tr = $("#gridContainer tr");
    $tr.find(".linkBtn-ready-pos").html(readyPosState[0]);
    $tr.find(".linkBtn-pos").html(posState[0]);

    $("#projectName").html(decodeURI(Url.getParam("projectName")));
}

var init = function(){
    initOptions();
    initComponent(Url.getParam("projectCode"));
    Event.bindEvent();
};

init();


</script>