<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!--<meta http-equiv="pragma" content="no-cache"> -->
    <META HTTP-EQUIV="pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Cache-Control" CONTENT="no-store, must-revalidate">
    <title>隐患填报模拟修改</title>
    <link rel="styleSheet" href="/static/dist/qualityFill/css/quality.css" />
    <script src="http://cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
    <script src="/static/dist/qualityFill/js/template.min.js"></script>
    <script src="/static/dist/qualityFill/js/wDialog.min.js"></script>
</head>
<body>

<div id="grid" class="grid">
    <table border="0" cellpadding="0" cellspacing="0">
        <thead>
            <tr>
                <td class="chk">隐患图片</td>
                <td class="w-middle">预设点</td>
                <!--<td class="w-small">检查结果</td>-->
                <td class="">隐患描述</td>
                <td class="w-big">构件位置</td>
                <td class="w-small">创建日期</td>
                <td class="w-small">整改日期</td>
                <td class="w-small">整改次数</td>
                <td class="w-small">状态</td>
                <td class="w-small">等级</td>
                <td class="w-small">填报人</td>
                <td class="w-small">打分类型</td>
                <td class="w-small">操作</td>
            </tr>
        </thead>
        <tbody id="gridContainer">
            <tr id="Grid" style="display:none;">
                <td class="chk">
                    <img src="{{imageUrl}}" style="width:60px;height:60px;" align="middle"/>
                </td>
                <td>
                    <span class="ready-pos" data-readypos=""></span>
                    <span class="linkBtn-ready-pos"></span>
                </td>
                <!--
                <td>
                    <span class="passLabel">{{}}</span>
                    <select class="pass" style="display:none;">
                        <option value="1">合格</option>
                        <option value="2">不合格</option>
                    </select>
                </td>
                -->
                <td>{{name}}</td>
                <td>
                    <span class="pos" data-pos=""></span>
                    <span class="linkBtn-pos"></span>
                </td>
                <td>{{discoverDate}}</td>
                <td>{{rectifyDate}}</td>
                <td>{{rectifyCount}}</td>
                <td>
                    <span class="status">{{status}}</span>
                    <select class="select-status" style="display:none;">
                        <option value="1">待整改</option>
                        <option value="2">已整改</option>
                        <option value="3">已关闭</option>
                    </select>
                </td>
                <td>{{levelId}}</td>
                <td>{{organizationTypeId}}</td>
                <td>{{ratingCategoryId}}</td>
                <td class="w-small">
                    <button class="btn_modify">修改</button>
                    <button class="btn_save" style="display:none;">保存</button>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div id="Dlg_content" style="display:block;">
    <div class="dlg-content">
        <div>
            <div id="repeatContainer" class="projectItem" style="display:none;">
                <span data-projectCode="{{projectCode}}" data-projectId="{{projectId}}">{{projectName}}</span>
            </div>            
        </div>

    </div>
    <div class="dlg-button">
        <button id="DlgBtn_close">关闭</button>
        <button id="DlgBtn_ok">确定</button>
    </div>
</div>

</body>
</html>
<script type="text/javascript">
Date.getDateFromMill = function(value){
    var date = new Date(value);
    return date.getFullYear() + "-" + (date.getMonth()+1) + "-" + date.getDate();
}

var Label = {
    checkResult:['','合格','不合格'],
    status:['','待整改','已整改','已关闭'],
    level :['','一般','较大','重大','特大'],
    person:['','质检中心','第三方','项目公司','监理单位'],
    classic:['','实测实量','防水工程','施工质量','安全文明','总包内业资料','材料设备']
};

var Url = {
    getParam : function(key){
        var search = location.search;
        search = search.replace("?","");
        var items = search.split("&");
        var item,i;
        for(i=0;i<items.length;i++)
        {
            item = items[i].split("=");
            if(item[0]==key)
            {
                return item[1];
            }
        }
        return "";          
    }   
};

var initDialog = function(){
    overLayer.bgColor='#777';
    overLayer.opacity=40;
    var options={
        id:'Dlg',
        hasBar:true,
        barOptions:
        {
            title:"请选择一个项目"
        },
        position:'fixed',
        type:'center',
        contentId:'Dlg_content',
        className:'dialog',
        width:800,
        height:500,
        isMove:false
    };
    window.Dlg = new wDialog(options);
}

var Event = {
    initDialogEvent : function(){
        var th = this;
        $("#Dlg .wClose").hide();
        window.Dlg.show();
        $("#DlgBtn_close").on("click",function(){
            window.Dlg.hide();
            $("#projectName").html(Data.projectData.projectName);
        });
        $("#DlgBtn_ok").on("click",function(){
            if(window.projectCode==undefined||window.projectCode=="")
            {
                alert("请选择一个项目");
                return;
            }
            window.Dlg.hide();
            th.getGridData(window.projectId);
        });

        var $Dlg_content = $("#Dlg .dlg-content");
        $Dlg_content.on("click",".projectItem",function(){
            var $dataDOM;
            $Dlg_content.find("div").removeClass("select");
            if(!$(this).hasClass("select"))
            {
                $(this).addClass("select");
                $dataDOM = $(this).find("span");
                window.projectCode = $dataDOM.data("projectcode");
                window.projectId = $dataDOM.data("projectid");
                window.projectName = $dataDOM.html();
            }
        });
    },
    initDialogData : function(){
        $.ajax({
            url:"/platform/project/list/all/quality",
            type:"get",
            dataType:"json",
            success:function(data){
                var list = data.data;
                if(data.code!=0)
                {
                    list = [];
                }
                template.startSymbol("{{");
                template.endSymbol("}}");
                template.repeat({
                    repeatElement:$("#repeatContainer")[0],
                    data:list,
                    type:"cover"
                });
            }
        });
    },

    getGridData : function(projectId){
        //var url = "/sixD/{projectId}/{projectId}/problem";
        var url = "/sixD/{projectId}/{projectId}/problem/zjmn";
        url = url.replace("{projectId}",projectId).replace("{projectId}",projectId);
        $.ajax({
            url:url,
            type:"get",
            dataType:"json",
            success:function(data){
                var list = data.data.items;
                console.log(list);
                if(data.code!=0)
                {
                    list = [];
                }
                template.startSymbol("{{");
                template.endSymbol("}}");
                template.repeat({
                    repeatElement:$("#Grid")[0],
                    data:list,
                    type:"cover",
                    process:function(dataRow){
                        var item = dataRow.item;
                        return{
                            "discoverDate" : Date.getDateFromMill(item.discoverDate),
                            "rectifyDate" : Date.getDateFromMill(item.rectifyDate),
                            "status" : Label.status[item.status],
                            "levelId" : Label.level[item.levelId],
                            "organizationTypeId" : Label.person[item.organizationTypeId],
                            "ratingCategoryId" : Label.classic[item.ratingCategoryId]
                        }
                    }
                });
            }
        });        
    },
    
    bindEvent : function(){
        var projectId = Url.getParam("projectId");
        if(projectId=="")
        {
            this.initDialogEvent();
            this.initDialogData();
        }
        else
        {
            this.getGridData(projectId);
        }
        $("#gridContainer").on("click","button.btn_modify",function(){
            var tr = this.parentNode.parentNode;
            $span = $(tr).find(".status");
            $select = $(tr).find(".select-status");
            $btnSave = $(tr).find("button.btn_save");
            $select.show();
            $span.hide();
            this.style.display = "none";
            $btnSave.show();
        });
        $("#gridContainer").on("click","button.btn_save",function(){
            var btnSave = this;
            var tr = btnSave.parentNode.parentNode;

            $span = $(tr).find(".status");
            $select = $(tr).find(".select-status");
            $btnModify = $(tr).find("button.btn_modify");            
            $.ajax({
                url:"/qqq",
                type:"get",
                success:function(data){
                    $span.show();
                    $span.html(Label.checkResult[$select.val()]);
                    $select.hide();
                    $btnModify.show();
                    $btnSave.hide();
                },
                error:function(e){
                    console.log(e);
                }
            });


        });
    }
};


var init = function(){
    initDialog();
    Event.bindEvent();
};

init();


</script>